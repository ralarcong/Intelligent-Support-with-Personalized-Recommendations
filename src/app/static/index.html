<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ClaraAI RAG Demo</title>
  <style>
    body{font-family:system-ui, sans-serif;max-width:60rem;margin:2rem auto;padding:0 1rem;}
    textarea{width:100%;height:6rem;padding:.5rem;font:inherit}
    button{margin:.5rem .25rem;padding:.5rem 1rem;font:inherit;cursor:pointer}
    /* visual feedback while disabled */
    button[disabled]{opacity:.5;cursor:not-allowed}
    pre{background:#f6f8fa;padding:1rem;border-radius:6px;white-space:pre-wrap}
  </style>
</head>
<body>
<h1>ClaraAI knowledge assistant</h1>

<label for="q">Ask something</label>
<textarea id="q" placeholder="e.g. How do payments work?"></textarea><br>
<button id="ask">Ask</button>
<button id="rec">Recommend unread docs</button>

<h2>Response</h2>
<pre id="out">(waiting …)</pre>

<script>
const uid   = "demo";
const $q    = document.getElementById("q");
const $out  = document.getElementById("out");
const $ask  = document.getElementById("ask");
const $rec  = document.getElementById("rec");

function setBusy(flag){ $ask.disabled = $rec.disabled = flag; }

function ask() {
  const question = $q.value.trim();
  if (!question) return;

  setBusy(true);
  $out.textContent = "";                       // clear
  const src = new EventSource(
      `/api/ask_stream?question=${encodeURIComponent(question)}&user_id=${uid}`,
      {withCredentials:false});

  src.onmessage = e => {                       // every token arrives here
    $out.textContent += e.data;
  };
  src.onerror = () => {
    src.close();
    setBusy(false);
  };
  src.onopen  = () => console.debug("⏳ stream started");
  src.addEventListener("end", () => {          // we never send this, fallback to close()
    src.close();
    setBusy(false);
  });
  src.addEventListener("close", () => {        // custom event if you emit one
    src.close();
    setBusy(false);
  });
  // when the server finishes it closes the connection => this `onclose` triggers
  src.onclose = () => setBusy(false);
}

async function recommend() {                   // unchanged
  setBusy(true);
  $out.textContent = "(waiting …)";
  try {
    const r = await fetch("/api/recommend", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({user_id: uid, top_k: 3})
    });
    $out.textContent = JSON.stringify(await r.json(), null, 2);
  } catch (err) {
    $out.textContent = "⚠️ " + err;
  } finally {
    setBusy(false);
  }
}

$ask.onclick = ask;
$rec.onclick = recommend;
</script>
  

</body>
</html>
